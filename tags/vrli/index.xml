<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>vrli on </title>
    <link>https://darrylcauldwell.com/tags/vrli/</link>
    <description>Recent content in vrli on </description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Tue, 05 Jul 2016 00:00:00 +0000</lastBuildDate><atom:link href="https://darrylcauldwell.com/tags/vrli/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Safely Lockdown NSX Distributed Firewall (DFW) Ruleset</title>
      <link>https://darrylcauldwell.com/post/nsx-dfw-lockdown/</link>
      <pubDate>Tue, 05 Jul 2016 00:00:00 +0000</pubDate>
      
      <guid>https://darrylcauldwell.com/post/nsx-dfw-lockdown/</guid>
      <description>
        
          &lt;p&gt;A common dilemma when developing a solution with firewall is whether to change the Default rule to Deny at the start and develop the ruleset as part of development or leave the Default rule to Allow and secure it later. In modern agile teams its best to develop the ruleset as part of development ensuring the ruleset is tested with the product as introducing it later could well invalidate every bit of testing performed.&lt;/p&gt;
&lt;p&gt;If however you find yourself in the situation where a NSX firewall solution is deployed with the Default rule to Allow and your asked to implement a ruleset to cover the traffic and change default to Deny. This is one possible solution to capture the required configuration.&lt;/p&gt;
&lt;h2 id=&#34;enable-default-rule-logging&#34;&gt;Enable Default Rule Logging&lt;/h2&gt;
&lt;p&gt;In order we can capture the active traffic we can first enable Logging on the default rule.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://darrylcauldwell.com/images/dFW-EnableLogging.jpg&#34; alt=&#34;NSX Enable Logging&#34;&gt;&lt;/p&gt;
&lt;p&gt;We can then operate the environment normally for a period of time which captures all business processes. This maybe a day, a week, a month or more.&lt;/p&gt;
&lt;h2 id=&#34;centralize-logging&#34;&gt;Centralize Logging&lt;/h2&gt;
&lt;p&gt;NSX data plane logging is written to the VMkernel.log files,  therefore if a logical firewall rule log is generated for a vNIC of a VM it is written to the ESX host log file which it was residing at that time.&lt;/p&gt;
&lt;p&gt;The distributed firewall configuration can apply to the whole vCenter and all objects within. You must therefore configure the remote syslog server for each host in each cluster that has firewall enabled. The remote syslog server is specified in the &lt;em&gt;Syslog.global.logHost&lt;/em&gt; attribute. My preference is to use vRealize Log Insight for centralized syslog.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://darrylcauldwell.com/images/dFW-EnableRemoteLogging.jpg&#34; alt=&#34;NSX Remote Logging&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;identifying-traffic-hitting-default-allow&#34;&gt;Identifying Traffic Hitting Default Allow&lt;/h2&gt;
&lt;p&gt;When we browse the firewall log entries we find that in order to narrow our search to the correct rule we need to establish the &lt;em&gt;vmw_nsx_firewall_ruleid&lt;/em&gt; for the default layer 3 rule which we are logging. The &lt;em&gt;vmw_nsx_firewall_ruleid&lt;/em&gt; is not displayed via the NSX Firewall GUI but can be easily got from the NSX REST API by running the GET method on this URL&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;https://&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;nsx-mgr-ip&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;/api/4.0/firewall/globalroot-0/config?ruleType&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;LAYER3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://darrylcauldwell.com/images/dFW-DefaultRuleID.jpg&#34; alt=&#34;NSX Default Rule ID&#34;&gt;&lt;/p&gt;
&lt;p&gt;We see in this example the &lt;em&gt;rule id=&amp;ldquo;1001&amp;rdquo;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Once we have this we can create a vRealize Log Insight query to list all logs generated by this rule.  To make this query easier to view I remove all columns except timestamp and vmw_nsx_firewall.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://darrylcauldwell.com/images/dFW-LI-Query.jpg&#34; alt=&#34;Query Firewall Events Log Insight &#34;&gt;&lt;/p&gt;
&lt;p&gt;From this data we can then identify what traffic would be blocked if we changed the default rule to Deny. We can work through this data, identify valid traffic flows. We can then put in explicit allow rules for the valid traffic. When we are happy no traffic is being logged by the Default Rule we can change it to Deny.&lt;/p&gt;

        
      </description>
    </item>
    
    <item>
      <title>Log Insight for VMware Integrated OpenStack</title>
      <link>https://darrylcauldwell.com/post/vrli-openstack/</link>
      <pubDate>Thu, 23 Apr 2015 00:00:00 +0000</pubDate>
      
      <guid>https://darrylcauldwell.com/post/vrli-openstack/</guid>
      <description>
        
          &lt;p&gt;vRealize Log Insight is not a product I have had much to do with up to now,  but that changed a few days ago when I was asked to perform an evaluation of how Log Insight might help with the management and administration of VMware Integrated OpenStack environment.&lt;/p&gt;
&lt;p&gt;So lets start what is vRealize Log Insight, in essence it is a tool for aggregating the viewing of all the log files from all aspects of your infrastructure. It delivers real-time log management, with machine learning-based Intelligent Grouping, and high performance search. While it is a VMware product it is fully extensible and can receive log files from any product,  the product vendor then writes a Log Insight content pack to give the intelligence to identify good and problem states.&lt;/p&gt;
&lt;p&gt;The environment I was given already had Log Insight 2.0A deployed, some of the content packs I was exploring for VMware Integrated OpenStack required the latest Log Insight 2.5.  Here I detail the &amp;lsquo;how to&amp;rsquo; steps I followed for upgrading Log Insight and then adding the content packs.&lt;/p&gt;
&lt;h2 id=&#34;log-insight-20a-to-25-upgrade&#34;&gt;Log Insight 2.0A to 2.5 Upgrade&lt;/h2&gt;
&lt;p&gt;The OpenStack content pack only supports Log Insight 2.5,  so to install this my first task is to upgrade Log Insight
itself,  this is is surprisingly easy.  Simply obtain a copy of the vRealize Log Insight upgrade bundle .pak file from &lt;a href=&#34;https://my.vmware.com/web/vmware/downloads&#34;&gt;VMware Downloads&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Connect to Log Insight as admin,  once connected select &amp;lsquo;Administration&amp;rsquo; from the menu icon in very top right corner, upload PAK file,  click Upgrade.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://darrylcauldwell.com/images/vrli-openstack-LogInsightUpgrade.jpg&#34; alt=&#34;Log Insight Upgrade&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;installing-openstack-log-insight-content-pack&#34;&gt;Installing OpenStack Log Insight Content Pack&lt;/h2&gt;
&lt;p&gt;There are two methods for installing content packs,  the first is via the Log Insight itself,  it has a market place feature which connects to the internet to get the list of available Content Packs you then click install and the tool does the rest.  While my test environment had internet access I could have used this,  but as most production workload is isolated from internet instead I opted for the offline method. The OpenStack content pack is downloadable from &lt;a href=&#34;https://solutionexchange.vmware.com/store/products/openstack-content-pack&#34;&gt;Solutions Exchange&lt;/a&gt;. It comes as a small zip file,  within the zip is a vlcp file,  extract this.&lt;/p&gt;
&lt;p&gt;Connect to Log Insight as admin,  once connected select &amp;lsquo;Content Packs&amp;rsquo; from menu icon in very top right corner,  select &amp;lsquo;Import Content Pack&amp;rsquo;,  you get the option now to install as a content pack (available to all) or into my content (available only to user importing).  Click Browse and find the extracted OpenStack vlcp file and click Import.&lt;/p&gt;
&lt;p&gt;I was surprised to find that the content pack did not require configuring with keystone location or credentials, I assume it picks these up from something VIO adds to vCenter, but it just worked which is great.&lt;/p&gt;
&lt;h2 id=&#34;installing-nsx-log-insight-content-pack&#34;&gt;Installing NSX Log Insight Content Pack&lt;/h2&gt;
&lt;p&gt;VMware Integrated Openstack uses NSX-MH,  so I installed NSX content pack,  it didn&amp;rsquo;t appear to get any data,  I was surprised to find when looking a little closer and speaking to our TAM that the current version of the content pack (v1.0) is NSX-V only.&lt;/p&gt;
&lt;h2 id=&#34;installing-arista-eos-switch-log-insight-content-pack&#34;&gt;Installing Arista-EOS Switch Log Insight Content Pack&lt;/h2&gt;
&lt;p&gt;Our VMware Integrated Openstack uses Arista EOS switches,  these integrate with NSX,  and Arista provide Content Pack, I used the same method as above to add the content pack to Log Insight.&lt;/p&gt;
&lt;p&gt;The Arista EOS switches don&amp;rsquo;t support Log Insight by default but they are extensible and Arista provide a Log Insight agent by way of an rpm file,  this is copied and installed to all of the switch&amp;rsquo;s and the loginsight.yaml file is then updated with the IP address of Log Insight server and the level of logging to perform.&lt;/p&gt;
&lt;h2 id=&#34;exploring-log-insight&#34;&gt;Exploring Log Insight&lt;/h2&gt;
&lt;p&gt;Having the power to look across every log file in the estate from a single pane of glass is hard to quantify until you start to work through an issue. The thing VMware have succeeded in doing with this product is keeping the view as clean and uncluttered as possible but still giving all and more of the required functionality.  All content packs provide a default dashboard view constructed to highlight the areas of there product which they believe would be of interest. Navigation in the dashboard view between content packs is via a menu at the top of the left pane,  once selected the left pane gives all of the sub dashboards you can see here OpenStack provides eleven dashboards one for each project.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://darrylcauldwell.com/images/vrli-openstack-LI_OS.png&#34; alt=&#34;Log Insight OpenStack&#34;&gt;&lt;/p&gt;
&lt;p&gt;You can use these dashboards to get a general idea about health,  but also you&amp;rsquo;ll have occurrences where users report an issue and you need to investigate.  Maybe a incident ticket got logged and it took a day or so to come through to you,  the dashboards show default last five minutes,  these can be set to show last hour,  last six hours or last twenty four hours,  but the most useful might be a custom time window.  The custom time window could be used to pick the day the issue occurred and it would update the dashboard to show what was going on in the log files at that time.  Here you might see a spike in events and want to drill in to the detail,  so you can just click on the spike and change to interactive view and it will display all the log entries for all components being managed which relating to that spike.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://darrylcauldwell.com/images/vrli-openstack-LI_IV.jpg&#34; alt=&#34;Log Insight Interactive View&#34;&gt;&lt;/p&gt;
&lt;p&gt;Once in the interactive view you have several options in the bottom pane to adjust the view,  the default view is &amp;lsquo;Events&amp;rsquo; as name suggests this lists all event entries.  If you change to &amp;lsquo;Field Table&amp;rsquo; this gives a little more structure to the view by separating out each part into a column.  The &amp;lsquo;Event Types&amp;rsquo; view collapses the Events by Type so if you have like 100 errors,  this view might show that there are only 3x types of error and that 70 are of type 1, 20 type 2 and 10 of type 3.  The &amp;lsquo;Event Trends&amp;rsquo; is as a progression from &amp;lsquo;Events by Type&amp;rsquo; and shows the collapsed view but shows which are trending into decline and which are trending up in occurrence.&lt;/p&gt;
&lt;h2 id=&#34;real-life-usage&#34;&gt;Real Life Usage&lt;/h2&gt;
&lt;p&gt;Its hard to quantify how useful Log Insight can be until you have to work through a proper issue.  Luckily (well maybe not lucky to get a fault) while looking at Log Insight a fault manifested itself to users in OpenStack Horizon that they could not deploy new VM instances.  I opened the Log Insight OpenStack content pack and without any awareness of the components of openstack could see nova had been reporting issues at the time the issues reported. The error messages were very generic and not leading to pointing to the fault so I went to the vSphere content pack and found messages which correlated to the time in nova which showed a ESXi host was having issues with clomd and suggested it needed restarting. CLOMD (Cluster Level Object Manager Daemon) plays a key role in the operation of a VSAN cluster so I checked VSAN dashboard in the content pack and could see other issues.  I then connected to the ESX host restarted clomd and the issue went away,  all this took about 5 minutes.  When I took a step back to think about this,  I had queries the log files of about 20-30 servers and was able to stay focused on the issue and the pattern of the fault rather than on logging on to the servers and finding the log files.  Bear in mind I&amp;rsquo;m not Log Insight expert this was my first day using it and its ease of use coupled with its power makes it a truly wonderful tool for the administrator.&lt;/p&gt;

        
      </description>
    </item>
    
  </channel>
</rss>
